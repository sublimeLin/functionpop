<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/img/admin/black_icon.png" type="image/gif" sizes="16x16">
  <title>
    <%- title %>
  </title>
  <link rel="stylesheet" type="text/css" href="/css/all.css" />
  <script src="https://kit.fontawesome.com/93e1c8f0af.js" crossorigin="anonymous"></script>
  <script src="/js/shop_cart/cart.js"></script>
  <script src="/js/shop_cart/jquery.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap"
    rel="stylesheet">

  <style>
    .owl-theme .owl-dots .owl-dot span {
      display: none;
    }

    .owl-carousel .img { 
      max-width: 374px;
      width: 100%;
      background-color: #ccc;
      max-height: 561px;
      height: 100%;
    }

    .owl-carousel p {
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <%- include("navbar.ejs") %>
      <%if(memberprofile){%>
        <span id="member" style="display: none">
          <%- memberprofile.cName %>
        </span>
        <% } %>

          <!-- outline_class  oib oig oi  oir-->
          <div class="container-lg">
            <!-- <%- include("template/loginbar") %> -->
            <div class="cart_content">
              <div class="row content_text">
                <div class="col-12 col-lg-9" style="padding: 0">
                  <div class="row cart_banner">
                    <div class="col-12 top_link d-none d-lg-block">
                      <ul class="cart-link">
                        <li><a href="/home">首頁</a></li>
                        <li>
                          <a><b style="user-select: none;">購物車</b> </a>
                        </li>
                      </ul>
                    </div>
                    <div class="col-12 mid mb-lg-3 ">
                      <div class="phTitle d-block d-lg-none mb-4"></div>
                      <h6 class="phTitleH" style="font-size: 1.4em; font-weight: 500">購物車</h6>
                    </div>
                    <div class="col-12 d-none d-lg-block cart-step">
                      <ul class="fz-dark" style="font-size: 1.4em;
                        font-weight: 500;">
                        <li style="color: #000">
                          <span style="background-color: #000">1</span>
                          查看購物車
                        </li>
                        <li>
                          <span>2</span>
                          訂單確認
                        </li>
                        <li>
                          <span>3</span>
                          訂單完成
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
                <div class="col-3 d-none d-lg-block"></div>
              </div>
              <div class="row content_pid m-0">
                <div class="col-12 col-lg-9">
                  <div class="cart container-fluid d-lg-block" style="display: none">
                    <div class="row fz-dark cart_title">
                      <div class="col-2">
                        <input type="checkbox" class="to_ck" checked />全選
                      </div>
                      <div class="col-3">商品名稱</div>
                      <div class="col-2">金額</div>
                      <div class="col-2">數量</div>
                      <div class="col">小計</div>
                      <div class="col"></div>
                    </div>
                  </div>

                  <div id="css_tbody" class="container-fluid css_tbody pt-lg-4 pt-3 pb-lg-2 pb-3">
                    <% if(cart){ %>
                      <% cart.forEach(function(item){ %>
                        <div class="row product mb-lg-0 mb-3" style="position: relative; padding: 0 18px 11px 18px">
                          <div class="col-lg-2 col-4 css_tb d-flex">
                            <div class="d-none d-lg-block" style="margin-right: auto">
                              <input type="checkbox" class="ck" checked />
                            </div>
                            <div style="
                                margin: auto;
                                max-height: 268px;
                                max-width: 186px;
                                height: 100%;
                                width: 100%;
                              ">
                              <img class="pImg" style="width: 100%; height: 100%" src="
                                <%if(item.image.length > 100){%>
                                  data:image/png;base64,<%- item.image %>
                                  <%}else{%> 
                                    /img/product/<%- item.image %>
                                    <%}%>
                                " alt="" />
                            </div>
                          </div>
                          <div class="col-lg-3 col-md-4 col-5 css_tb align-self-lg-center pt-2">
                            <p class="pDesc" style="    font-size: 1.4em;
                              margin-bottom: 10px;
                              font-weight: 600;">
                              <%- item.name %>
                            </p>

                            <p class="pColor m-0">顏色:<%- item.color %>
                            </p>
                            <p class="pSize m-0">尺寸:<%- item.size %>
                            </p>
                            <p class="d-lg-none" style="display: block">
                              NT$ <span class="price">
                                <%- item.price %>
                              </span>
                            </p>
                          </div>
                          <div class="col-2 css_tb align-self-center d-lg-block" style="display: none">
                            NT$ <span class="price">
                              <%- item.price %>
                            </span>

                            <!-- NT$ <span class="price"> <%- item.price %> </span> -->
                          </div>
                          <div class="col-2 d-none d-lg-block css_tb pCount align-self-center">
                            <span style="box-shadow: 0px 0px 1px #000; padding: 6px 0">
                              <a href="javascript:" class="q_sub" data-allId="<%- item.all_id %>" style="
                          display: inline-block;
                          padding: 6px;
                          border-right: 1px solid #000;
                          color: #000;
                          text-decoration: none;
                        ">-</a>
                              <input type="text" id="number" value="<%- item.quantity %>"
                                style="width: 25px; border: none; text-align: center" />
                              <a href="javascript:" class="q_add" data-allId="<%- item.all_id %>" style="
                          display: inline-block;
                          padding: 6px;
                          border-left: 1px solid #000;
                          color: #000;
                        ">+</a>
                            </span>
                          </div>
                          <% let toP=item.quantity * item.price %>
                            <div class="col css_tb d-none d-lg-block align-self-center">
                              NT$ <span class="to_price">
                                <%- toP %>
                              </span>
                            </div>
                            <div
                              class="col p-0 css_tb d-lg-block d-flex flex-column flex-lg-row align-self-lg-center text-right text-lg-left">
                              <a style="color: #000" href="javascript:" class="del" data-allId="<%- item.all_id %>"><i
                                  class="pr-3 pr-lg-0 fa-solid fa-trash-can"
                                  style="font-family: 'Font Awesome 6 Free' !important;"></i></a>
                              <div style="font-size: 1.8em; padding: 0px 0px 20px 7px"
                                class="pr-3 pr-lg-0 mt-auto d-lg-none pb-2">
                                <span style="font-weight: 600">
                                  <input type="text" value="<%- item.quantity %>" style="
                            width: 25px;
                            text-align: center;
                            vertical-align: bottom;
                          " />

                                  件
                                </span>
                              </div>
                            </div>
                        </div>
                        <% }); %>
                          <% } %>
                  </div>
                </div>
                <div class="col-12 col-lg-3 p-lg-0">
                  <hr class="d-lg-none" style="border-top: 0.9px solid #000">
                  <div class="div cart_Order">
                    <div class="d-none d-lg-block" style="text-align: center">
                      <p style="
                        font-size: 1.6em;
    font-weight: 700;
                        ">訂單確認</p>
                    </div>
                    <div class="py-2 borderOut">
                      <p class="d-none d-lg-block">
                        <b>總計商品件數:</b>
                        <span class="float-right"><span id="total_count">0</span> 件</span>
                      </p>
                      <p>
                        <b>小計:</b><span class="float-right">NT$<span id="total_price">0</span></span>
                      </p>
                      <p>
                        <b>運費:</b><span class="float-right">NT$<span id="fare" class="fare">0</span></span>
                      </p>
                    </div>
                    <div class="py-3 d-none d-lg-block" class="canFare" id="canFare">
                      只差NT$ <span>0</span>，即可享有<span style="color: #f00;">免費</span>標準運送。
                    </div>
                    <div class="pt-2 mb-4">
                      <p style="font-size: 1.6em;">
                        <b>總額:</b><span class="float-right" style="font-weight: 700;">NT$<span
                            id="tototoPrice">0</span></span>
                      </p>
                    </div>
                    <!-- action="/home/shop_cart/orderCheck" -->
                    <form class="text-center" id="buy" action="">
                      <button id="sub" type="submit">結帳</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <hr style="border-top: 0.9px solid #000" />
            <div class="container">
              <div class="row d-none d-md-block">
                <div style="font-weight: 700" class="col text-center mb-3 mt-2">
                  <i class="fas fa-fire-alt"
                    style="color: #ff8046cc; font-family: 'Font Awesome 6 Free' !important;"></i>

                  熱門商品
                </div>
              </div>
              <div class="row d-none d-md-block">
                <div class="col">
                  <div class="owl-carousel owl-theme">
                    <% result.forEach(function(item){ %>
                      <div class="item">
                        <div>
                          <a href="/home/product/<%- item.product_gender %>/single_product/<%- item.product_id %>">
                            <div class="img" style="margin:auto;">
                              <img style=" width: 100%; height: 100%; border-radius: 2px"
                                src="/img/product/<%- item.product_image %>" alt="" />
                            </div>
                          </a>
                        </div>

                        <div style="
                      font-weight: 700;
                      text-align: center;
                      margin-top: 7px;
                      font-size: 0.9em;
                    ">
                          <p>
                            <%- item.product_name %>
                          </p>
                        </div>
                      </div>
                      <% }); %>
                  </div>
                </div>
              </div>
              <div class="row d-md-none">
                <div class="col" style="padding: 67px 0;">
                  <div style="padding: 0 21px;  position: relative;">
                    <img style="width: 100%; height:100%;" src="/img/shop_cart/text_phone06.jpg" alt="">
                    <div style="
                      margin-top: 16px;
                      color: #1B191C;
                      line-height: 0;">
                      <h5 style="    
                        letter-spacing: -0.8px;
                        font-weight: 700;
                        "> 聯名新款現已上市<span style="margin-left: 7px; color: #FFE200;font-weight: 900;">#</span></h5>
                      <p style="    
       font-size: 0.7em;
    font-weight: 500;
    margin-top: 15.9px;
    padding-left: 1.4px;
                        ">更多樂趣,&ensp; 盡情享受,&ensp; 品嘗鮮豔色彩</p>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="push"></div>
  </div>
  <%- include("footer.ejs") %>
    <script>
      $(document).ready(function () {
        $("input[class='ck']").on("change", function (x) {
          var isCk = true;
          $("input[class='ck']").each(function (idx, ele) {
            if (!$(ele).prop("checked")) {
              isCk = false;
            } else {
              isCk = true;
            }
            return isCk;
          });
          $("input[class='to_ck']").prop("checked", isCk);

          updateCount();
          updateAllPrice();
        });

        updateCount();
        updateAllPrice();

        //商品增加
        $(".q_add").click(function () {
          var num = 0;
          num++;
          var Count = parseInt($(this).siblings("#number").val());
          var to_Count = parseInt(Count + num);
          var price = parseInt(
            $(this).parent().parent().parent().find(".price").text()
          );
          var to_price = 0;
          to_price = price * to_Count;
          $(this).siblings("#number").val(to_Count);
          $(this)
            .parent()
            .parent()
            .parent()
            .find(".to_price")
            .html(to_price.toString());

          let all_id = {};
          all_id.allId = $(this).attr("data-allId");
          updateCount();
          updateAllPrice();

          $.ajax({
            url: "/home/shop_cart/q_add",
            type: "POST",
            data: all_id,
            success: function (res) {
              // console.log("新增");
            },
            error: function () {
              alert("系統錯誤");
            },
          });
        });

        //商品減少
        $(".q_sub").click(function () {
          var Count = parseInt($(this).siblings("#number").val());

          if (Count <= 1) {
            Count = 1;
          } else {
            Count--;
            var price = parseInt(
              $(this).parent().parent().parent().find(".price").text()
            );
            var to_price = 0;
            to_price = price * Count;
            $(this)
              .parent()
              .parent()
              .parent()
              .find(".to_price")
              .html(to_price.toString());
            $(this).siblings("#number").val(Count);

            let all_id = {};
            all_id.allId = $(this).attr("data-allId");
            updateCount();
            updateAllPrice();

            $.ajax({
              url: "/home/shop_cart/q_sub",
              type: "POST",
              data: all_id,
              success: function (res) {
                // console.log("成功");
              },
              error: function () {
                alert("系統錯誤");
              },
            });
          }
        });

        // 刪除按鈕
        $(".del").click(function (x) {
          if (confirm("確定刪除此商品")) {
            let all_id = {};
            all_id.allId = $(this).attr("data-allId");
            console.log(all_id);

            $(this).parent().parent().remove();
            $.ajax({
              url: "/home/shop_cart/del",
              type: "POST",
              data: all_id,

              success: function (res) {
                console.log("已刪除all_id:" + all_id.allId + " 商品");
                updateCount();
                updateAllPrice();
              },
              error: function () {
                alert("系統錯誤");
              },
            });
          }
        });
        $("#sub").click(function () {
          if ($("#css_tbody ").has(".product").length ? true : false) {
            if ($("#member").length ? true : false) {
              $.ajax({
                url: "/home/shop_cart/orderCheck",
                type: "GET",
                success: function (res) {
                  console.log("傳送成功");
                },
                error: function () {
                  console.log("傳送失敗");
                },
              });
              $("#buy").prop("action", "/home/shop_cart/orderCheck");
              return true;
            } else {
              $("#buy").prop("action", "/home/member/login");
              alert("請先登入");
              return true;
            }
          } else {
            alert("目前沒有任何商品");
            return false;
          }
        });
      }); //準備結束
    </script>

    <script src="/js/shop_cart/owl.carousel.js"></script>
    <script src="/js/shop_cart/owl.js"></script>
    <script src="/js/shop_cart/bootstrap.js"></script>
</body>

</html>